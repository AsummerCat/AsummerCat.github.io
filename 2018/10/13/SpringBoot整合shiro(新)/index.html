<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/%E9%A3%9E%E5%A4%A9%E5%B0%8F%E5%A5%B3%E8%AD%A6_%E8%8A%B1%E8%8A%B1.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/%E9%A3%9E%E5%A4%A9%E5%B0%8F%E5%A5%B3%E8%AD%A6_%E8%8A%B1%E8%8A%B1.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.geekzu.org/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.linjingc.top","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="#demo地址     参考:1.Spring Boot Shiro 权限信息缓存处理,记住我，thymleaf使用shiro标签2.https:&#x2F;&#x2F;blog.csdn.net&#x2F;xtiawxf&#x2F;article&#x2F;details&#x2F;52571949"><meta property="og:type" content="article"><meta property="og:title" content="SpringBoot整合shiro(新)"><meta property="og:url" content="http://www.linjingc.top/2018/10/13/SpringBoot%E6%95%B4%E5%90%88shiro(%E6%96%B0)/index.html"><meta property="og:site_name" content="emmm读书使我快乐"><meta property="og:description" content="#demo地址     参考:1.Spring Boot Shiro 权限信息缓存处理,记住我，thymleaf使用shiro标签2.https:&#x2F;&#x2F;blog.csdn.net&#x2F;xtiawxf&#x2F;article&#x2F;details&#x2F;52571949"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2018-10-12T19:11:10.000Z"><meta property="article:modified_time" content="2023-12-06T03:17:10.809Z"><meta property="article:author" content="一只写Bug的猫"><meta property="article:tag" content="SpringBoot"><meta property="article:tag" content="shiro"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://www.linjingc.top/2018/10/13/SpringBoot%E6%95%B4%E5%90%88shiro(%E6%96%B0)/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://www.linjingc.top/2018/10/13/SpringBoot%E6%95%B4%E5%90%88shiro(%E6%96%B0)/","path":"2018/10/13/SpringBoot整合shiro(新)/","title":"SpringBoot整合shiro(新)"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>SpringBoot整合shiro(新) | emmm读书使我快乐</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">emmm读书使我快乐</p><i class="logo-line"></i></a></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-number">2.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#shiro%E5%B8%B8%E8%A7%81%E7%9A%84%E5%BC%82%E5%B8%B8%E7%B1%BB"><span class="nav-number">3.</span> <span class="nav-text">shiro常见的异常类</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5pom-xml"><span class="nav-number">4.</span> <span class="nav-text">导入pom.xml</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E7%9A%84%E5%AE%9E%E4%BD%93"><span class="nav-number">5.</span> <span class="nav-text">创建一个用户登录的实体</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%88%E6%9D%83%E7%99%BB%E5%BD%95%E7%B1%BB"><span class="nav-number">6.</span> <span class="nav-text">创建自定义授权登录类</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9C%A8application-properties%E4%B8%AD%E6%B7%BB%E5%8A%A0-%E5%85%B3%E4%BA%8Eshiro%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-number">7.</span> <span class="nav-text">在application.properties中添加 关于shiro的配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8A%A0%E7%9B%90%E6%B5%8B%E8%AF%95%E7%B1%BB"><span class="nav-number">8.</span> <span class="nav-text">加盐测试类</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AF%86%E7%A0%81%E5%8C%B9%E9%85%8D%E7%B1%BB"><span class="nav-number">9.</span> <span class="nav-text">编写自定义密码匹配类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%AD%E8%AF%81%E5%8C%B9%E9%85%8D%E5%99%A8-%E7%84%B6%E5%90%8E-%E7%9B%B4%E6%8E%A5%E5%AF%B9%E6%AF%94%E5%AF%86%E7%A0%81%E6%98%AF%E5%90%A6%E8%B7%9F%E5%BA%93%E9%87%8C%E7%9B%B8%E7%AD%89"><span class="nav-number">9.1.</span> <span class="nav-text">自定义凭证匹配器 然后 直接对比密码是否跟库里相等</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%AD%E8%AF%81%E5%8C%B9%E9%85%8D%E5%99%A8-%E7%84%B6%E5%90%8E%E6%A0%B9%E6%8D%AE%E5%8A%A0%E7%9B%90%E6%9D%A5%E5%8C%B9%E9%85%8D"><span class="nav-number">9.2.</span> <span class="nav-text">自定义凭证匹配器 然后根据加盐来匹配</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B4%E6%8E%A5%E5%86%99%E5%9C%A8ShiroConfig%E4%B8%AD-%E7%A8%8D%E5%90%8E%E5%88%9B%E5%BB%BA"><span class="nav-number">9.3.</span> <span class="nav-text">直接写在ShiroConfig中 稍后创建</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAshiro%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%85%8D%E7%BD%AE%E7%B1%BB-%E5%8D%95%E7%8B%AC"><span class="nav-number">10.</span> <span class="nav-text">创建shiro生命周期配置类(单独)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAshiro%E9%85%8D%E7%BD%AE%E7%B1%BB-%E5%AE%8C%E6%95%B4"><span class="nav-number">11.</span> <span class="nav-text">创建shiro配置类(完整)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#shiro%E9%85%8D%E7%BD%AE%E7%B1%BB%E4%B8%AD%E5%8A%A0%E5%85%A5-thymeleaf-%E5%9C%A8%E9%A1%B5%E9%9D%A2%E4%BD%BF%E7%94%A8shiro%E7%9A%84%E6%A0%87%E7%AD%BE%E7%9A%84bean"><span class="nav-number">12.</span> <span class="nav-text">shiro配置类中加入 thymeleaf 在页面使用shiro的标签的bean</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#shiro%E9%85%8D%E7%BD%AE%E7%B1%BB%E4%B8%AD%E5%8A%A0%E5%85%A5-%E5%AE%9E%E7%8E%B0-%E4%BB%A3%E7%A0%81%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="nav-number">13.</span> <span class="nav-text">shiro配置类中加入 实现 代码中使用注解</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9C%A8shiro%E4%B8%AD%E5%8A%A0%E5%85%A5EhCache%E7%BC%93%E5%AD%98-%E7%BC%93%E5%AD%98%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E4%BF%A1%E6%81%AF"><span class="nav-number">14.</span> <span class="nav-text">在shiro中加入EhCache缓存 缓存用户权限信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5pom-xml-%E7%9C%8B%E9%A1%B6%E9%83%A8%E6%A0%87%E9%A2%98-%E5%AF%BC%E5%85%A5pom%E7%9A%84%E9%82%A3%E9%83%A8%E5%88%86"><span class="nav-number">14.1.</span> <span class="nav-text">导入pom.xml 看顶部标题 导入pom的那部分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8shiro%E9%85%8D%E7%BD%AE%E7%B1%BB%E4%B8%AD%E5%8A%A0%E5%85%A5EhCache%E7%BC%93%E5%AD%98%E5%99%A8"><span class="nav-number">14.2.</span> <span class="nav-text">在shiro配置类中加入EhCache缓存器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8resources%E4%B8%AD%E6%B7%BB%E5%8A%A0%E5%85%B3%E4%BA%8EEhCache%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">14.3.</span> <span class="nav-text">在resources中添加关于EhCache的配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E7%9A%84Ehcache%E5%8A%A0%E5%85%A5%E5%88%B0shiro%E7%9A%84%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E5%99%A8%E4%B8%AD"><span class="nav-number">14.4.</span> <span class="nav-text">开启的Ehcache加入到shiro的安全管理器中</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#shiro%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98%E6%9D%A5%E5%AD%98%E5%82%A8%E7%94%A8%E6%88%B7%E9%AA%8C%E8%AF%81%E6%97%B6%E5%AF%86%E7%A0%81%E5%A4%9A%E6%AC%A1%E8%BE%93%E5%85%A5%E9%94%99%E8%AF%AF"><span class="nav-number">15.</span> <span class="nav-text">shiro使用缓存来存储用户验证时密码多次输入错误</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E7%B1%BB-%E7%BB%A7%E6%89%BF-HashedCredentialsMatcher"><span class="nav-number">15.1.</span> <span class="nav-text">创建一个自定义的类 继承 HashedCredentialsMatcher</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9shiroConfig%E4%B8%AD%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AF%86%E7%A0%81%E6%A0%A1%E9%AA%8C%E5%99%A8"><span class="nav-number">15.2.</span> <span class="nav-text">修改shiroConfig中的自定义密码校验器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8Ehcache-xml%E4%B8%AD%E6%B7%BB%E5%8A%A0%E5%85%B3%E4%BA%8E%E5%AF%86%E7%A0%81%E9%94%99%E8%AF%AF%E6%AC%A1%E6%95%B0%E7%9A%84%E7%BC%93%E5%AD%98"><span class="nav-number">15.3.</span> <span class="nav-text">在Ehcache.xml中添加关于密码错误次数的缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8application-properties%E4%B8%AD%E6%B7%BB%E5%8A%A0"><span class="nav-number">15.4.</span> <span class="nav-text">在application.properties中添加</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%B0%E4%BD%8F%E5%AF%86%E7%A0%81"><span class="nav-number">16.</span> <span class="nav-text">记住密码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E5%85%A5%E4%B8%A4%E4%B8%AA%E6%96%B9%E6%B3%95"><span class="nav-number">16.1.</span> <span class="nav-text">加入两个方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E5%85%A5%E5%88%B0%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E5%99%A8%E4%B8%AD"><span class="nav-number">16.2.</span> <span class="nav-text">加入到安全管理器中</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%84%B6%E5%90%8E%E5%86%8DShirofiter%E8%BF%87%E6%BB%A4%E5%99%A8%E4%B8%AD%E6%B7%BB%E5%8A%A0-%E8%AE%B0%E4%BD%8F%E6%88%91%E7%9A%84%E8%B7%AF%E5%BE%84"><span class="nav-number">16.3.</span> <span class="nav-text">然后再Shirofiter过滤器中添加 记住我的路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2%E5%8A%A0%E5%85%A5rememberMe%E5%A4%8D%E9%80%89%E6%A1%86"><span class="nav-number">16.4.</span> <span class="nav-text">登录界面加入rememberMe复选框</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">16.5.</span> <span class="nav-text">使用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">17.</span> <span class="nav-text">注意事项</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E6%97%B6%E6%8A%A5%E9%94%99-%E3%80%90Springboot-Themeleaf%E6%A8%A1%E6%9D%BF-Shiro%E6%A0%87%E7%AD%BE%E3%80%91%E6%89%BE%E4%B8%8D%E5%88%B0%E7%B1%BBAbstractProcessorDialect%E8%A7%A3%E5%86%B3"><span class="nav-number">18.</span> <span class="nav-text">启动时报错 【Springboot+Themeleaf模板+Shiro标签】找不到类AbstractProcessorDialect解决</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%81%87%E5%88%B0-value-%E6%97%A0%E6%B3%95%E6%B3%A8%E5%85%A5%E5%88%B0%E9%85%8D%E7%BD%AE%E7%B1%BB%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">19.</span> <span class="nav-text">遇到@value() 无法注入到配置类的情况</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81%E7%B1%BB%E4%B8%AD-%E7%9A%84%E8%AE%A4%E8%AF%81%E5%87%BA%E9%94%99%E7%9A%84%E8%AF%9D"><span class="nav-number">20.</span> <span class="nav-text">如果权限验证类中 的认证出错的话</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%99%BB%E5%BD%95%E7%99%BB%E5%87%BA%E7%9A%84%E6%97%B6%E5%80%99org-apache-shiro-crypto-CryptoException-Unable-to-execute-%E2%80%98doFinal%E2%80%99-with-cipher-instance"><span class="nav-number">21.</span> <span class="nav-text">登录登出的时候org.apache.shiro.crypto.CryptoException: Unable to execute ‘doFinal’ with cipher instance</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="一只写Bug的猫" src="/img/WechatIMG230.jpeg"><p class="site-author-name" itemprop="name">一只写Bug的猫</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">841</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">200</span> <span class="site-state-item-name">标签</span></a></div></nav></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://www.linjingc.top/2018/10/13/SpringBoot%E6%95%B4%E5%90%88shiro(%E6%96%B0)/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/img/WechatIMG230.jpeg"><meta itemprop="name" content="一只写Bug的猫"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="emmm读书使我快乐"><meta itemprop="description" content=""></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="SpringBoot整合shiro(新) | emmm读书使我快乐"><meta itemprop="description" content=""></span><header class="post-header"><h1 class="post-title" itemprop="name headline">SpringBoot整合shiro(新)</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-10-12 19:11:10" itemprop="dateCreated datePublished" datetime="2018-10-12T19:11:10Z">2018-10-12</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-12-06 03:17:10" itemprop="dateModified" datetime="2023-12-06T03:17:10Z">2023-12-06</time> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>32k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>29 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>#<a target="_blank" rel="noopener" href="https://github.com/AsummerCat/SpringBootAndShiroNow">demo地址</a></p><hr><blockquote><p>参考:<br>1.<a target="_blank" rel="noopener" href="https://blog.csdn.net/u014695188/article/details/52356158">Spring Boot Shiro 权限信息缓存处理,记住我，thymleaf使用shiro标签</a><br>2.<a target="_blank" rel="noopener" href="https://blog.csdn.net/xtiawxf/article/details/52571949">https://blog.csdn.net/xtiawxf/article/details/52571949</a></p></blockquote><span id="more"></span><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote><p>集成Shiro核心内容:</p><p>1.ShiroFilterFactory，Shiro过滤器工程类，具体的实现类是：ShiroFilterFactoryBean，此实现类是依赖于SecurityManager安全管理器。主要配置Filter就好。</p></blockquote><!--more--><blockquote><p>2.SecurityManager，Shiro的安全管理，主要是身份认证的管理，缓存管理，cookie管理，所以在实际开发中我们主要是和SecurityManager进行打交道的。</p><p>3.Realm,用于身份信息权限信息的验证。开发时集成AuthorizingRealm，重写两个方法:doGetAuthenticationInfo(获取即将需要认真的信息)、doGetAuthorizationInfo(获取通过认证后的权限信息)。</p><p>4.HashedCredentialsMatcher，凭证匹配器，用于告诉Shiro在认证时通过什么方式(算法)来匹配密码。默认(storedCredentialsHexEncoded&#x3D;false)Base64编码，可以修改为(storedCredentialsHexEncoded&#x3D;true)Hex编码。</p><p>5.LifecycleBeanPostProcessor，Shiro生命周期处理器，保证实现了Shiro内部lifecycle函数的bean执行。</p></blockquote><blockquote><p>6.开启Shiro的注解功能(如@RequiresRoles,@RequiresPermissions),需借助SpringAOP扫描使用Shiro注解的类,并在必要时进行安全逻辑验证，需要配置两个bean(DefaultAdvisorAutoProxyCreator(可选)和AuthorizationAttributeSourceAdvisor)实现此功能。</p><p>7.其它的就是缓存管理，记住登录、验证码、分布式系统共享Session之类的，这些大部分都是需要自己进行的实现，其中缓存管理，记住登录比较简单实现，并需要注入到SecurityManager让Shiro的安全管理器进行管理就好了。后续章节中会一 一补充。</p></blockquote><h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><p>0.shiro常见的异常类<br>1.导入相关的pom.xml<br>2.创建用户登录的实体<br>3.创建自定义授权登录类<br>4.application.properties中添加 关于shiro的配置<br>5.加盐测试类<br>6.编写自定义密码匹配类<br>7.创建shiro生命周期配置类(单独)<br>8.创建shiro配置类(完整)<br>9.shiro配置类中加入 thymeleaf 在页面使用shiro的标签的bean<br>10.shiro配置类中加入 实现 代码中使用注解<br>11.在shiro中加入EhCache缓存 缓存用户权限信息<br>12.shiro使用缓存来存储用户验证时密码多次输入错误<br>13.记住密码<br>14.注意事项</p><hr><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局获取shiro中的当前用户</span></span><br><span class="line">SecurityUtils<span class="selector-class">.getSubject</span>()<span class="selector-class">.getPrincipal</span>() </span><br></pre></td></tr></table></figure><hr><h1 id="shiro常见的异常类"><a href="#shiro常见的异常类" class="headerlink" title="shiro常见的异常类"></a>shiro常见的异常类</h1><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">(验证)</span><br><span class="line">authc:</span><br><span class="line">AuthencationException:</span><br><span class="line">AuthenticationException 异常是Shiro在登录认证过程中，认证失败需要抛出的异常。</span><br><span class="line"></span><br><span class="line">AuthenticationException包含以下子类：</span><br><span class="line"></span><br><span class="line">    CredentitalsException 凭证异常</span><br><span class="line"></span><br><span class="line">        IncorrectCredentialsException 不正确的凭证</span><br><span class="line"></span><br><span class="line">        ExpiredCredentialsException 凭证过期</span><br><span class="line"></span><br><span class="line">    AccountException 账号异常</span><br><span class="line"></span><br><span class="line">        ConcurrentAccessException 并发访问异常（多个用户同时登录时抛出）</span><br><span class="line"></span><br><span class="line">        UnknownAccountException 未知的账号</span><br><span class="line"></span><br><span class="line">        ExcessiveAttemptsException 认证次数超过限制</span><br><span class="line"></span><br><span class="line">        DisabledAccountException 禁用的账号</span><br><span class="line">            LockedAccountException 账号被锁定</span><br><span class="line"></span><br><span class="line">    UnsupportedTokenException 使用了不支持的Token</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">###############################################################################################</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">authz:</span><br><span class="line">AuthorizationException:</span><br><span class="line">子类:</span><br><span class="line">    UnauthorizedException:抛出以指示请求的操作或对请求的资源的访问是不允许的。</span><br><span class="line">    UnanthenticatedException:当尚未完成成功认证时，尝试执行授权操作时引发异常。</span><br><span class="line">    (授权只能在成功的认证之后执行，因为授权数据（角色、权限等）必须总是与已知的标识相关联。这样的已知身份只能在成功登录时获得。)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="导入pom-xml"><a href="#导入pom-xml" class="headerlink" title="导入pom.xml"></a>导入pom.xml</h1><p>导入shiro相关</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- siro安全框架 --&gt;</span></span><br><span class="line">     <span class="comment">&lt;!-- shiro spring. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="comment">&lt;!-- shiro ehcache --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-ehcache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><!--more--><p>然后再导入 页面整合shiro的相关内容</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 在Thymeleaf模板引擎中集成Shiro --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.theborakompanioni<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-shiro<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>	</span><br></pre></td></tr></table></figure><p>其他:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 包含支持UI模版（Velocity，FreeMarker，JasperReports）， 邮件服务， 脚本服务(JRuby)， 缓存Cache（EHCache）， 任务计划Scheduling（uartz）。 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h1 id="创建一个用户登录的实体"><a href="#创建一个用户登录的实体" class="headerlink" title="创建一个用户登录的实体"></a>创建一个用户登录的实体</h1><p>需要注意的是 <code>实体需要序列化</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjingc.demo.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> cxc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/10/12 09:16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Set roles;</span><br><span class="line">    <span class="keyword">private</span> String salt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h1 id="创建自定义授权登录类"><a href="#创建自定义授权登录类" class="headerlink" title="创建自定义授权登录类"></a>创建自定义授权登录类</h1><p><code>AuthRealm</code>完成根据用户名去数据库的查询,并且将用户信息放入shiro中,供第二个类调用.<code>CredentialsMatcher</code>,完成对于密码的校验.其中用户的信息来自shiro.AuthRealm类如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjingc.demo.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.linjingc.demo.service.UserService;</span><br><span class="line"><span class="keyword">import</span> com.linjingc.demo.vo.User;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> cxc</span></span><br><span class="line"><span class="comment"> * shiro自定义授权类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthRealm</span> <span class="keyword">extends</span> <span class="title class_">AuthorizingRealm</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;shiro.salt&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String shiroSalt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//认证.登录</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="comment">//UsernamePasswordToken对象用来存放提交的登录信息 登录表单</span></span><br><span class="line">        <span class="type">UsernamePasswordToken</span> <span class="variable">utoken</span> <span class="operator">=</span> (UsernamePasswordToken) token;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> utoken.getUsername();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实际项目中，这里可以根据实际情况做缓存，如果不做，Shiro自己也是有时间间隔机制，2分钟内不会重复执行该方法</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserByUserName(username);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用户是否存在</span></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnknownAccountException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加盐 可以自定义可以尝试  userName+salt</span></span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">salt</span> <span class="operator">=</span> ByteSource.Util.bytes(user.getUsername() + shiroSalt);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//放入Shiro.调用CredentialsMatcher检验密码</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthenticationInfo</span>(user, user.getPassword(), salt, getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//授权</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthorizationInfo <span class="title function_">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principal)</span> &#123;</span><br><span class="line">        <span class="comment">//获取session中的用户</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) principal.getPrimaryPrincipal();</span><br><span class="line">        log.info(<span class="string">&quot;当前用户授权中&quot;</span>);</span><br><span class="line">        List&lt;String&gt; permissions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;String&gt; userRoles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用户角色</span></span><br><span class="line">        <span class="type">Set</span> <span class="variable">roles</span> <span class="operator">=</span> user.getRoles();</span><br><span class="line">        <span class="keyword">if</span> (roles.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//将查询到的用户权限放入一个权限集合中</span></span><br><span class="line">            permissions.addAll(roles);</span><br><span class="line">            <span class="comment">//将查询到的用户角色放入一个角色集合中</span></span><br><span class="line">            userRoles.add(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SimpleAuthorizationInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthorizationInfo</span>();</span><br><span class="line">        <span class="comment">//将权限放入shiro中.</span></span><br><span class="line">        info.addStringPermissions(permissions);</span><br><span class="line">        <span class="comment">//将用户角色放入session</span></span><br><span class="line">        info.addRoles(userRoles);</span><br><span class="line">        log.info(<span class="string">&quot;当前用户授权成功&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h1 id="在application-properties中添加-关于shiro的配置"><a href="#在application-properties中添加-关于shiro的配置" class="headerlink" title="在application.properties中添加 关于shiro的配置"></a>在application.properties中添加 关于shiro的配置</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#自定义shiro加密类型 散列算法:MD5,sha-1,sha-256</span></span><br><span class="line"><span class="attr">shiro.encrypt.type</span>=MD5</span><br><span class="line"><span class="comment">#自定义shiro加密次数</span></span><br><span class="line"><span class="attr">shiro.HashIterations</span>=<span class="number">1024</span></span><br><span class="line"><span class="comment">#自定义shiro加盐的通用部分</span></span><br><span class="line"><span class="attr">shiro.salt</span>=ABCDEFG</span><br><span class="line"><span class="comment">#自定义密码错误上限</span></span><br><span class="line"><span class="attr">shiro.password.error.size</span>=<span class="number">5</span></span><br><span class="line"><span class="comment">#shiro记住我的session最大时长 秒</span></span><br><span class="line"><span class="attr">shiro.rememberMe.Max.time</span>=<span class="number">259200</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#关闭thymeleaf页面缓存</span></span><br><span class="line"><span class="attr">spring.thymeleaf.cache</span>=<span class="literal">false</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h1 id="加盐测试类"><a href="#加盐测试类" class="headerlink" title="加盐测试类"></a>加盐测试类</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjingc.demo.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.hash.SimpleHash;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> cxc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/10/12 11:42</span></span><br><span class="line"><span class="comment"> * 加盐测试类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaltUtil</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加盐测试类</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hashAlgorithmName</span> <span class="operator">=</span> <span class="string">&quot;MD5&quot;</span>;<span class="comment">//加密方式</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">crdentials</span> <span class="operator">=</span> <span class="string">&quot;a123456&quot;</span>;<span class="comment">//密码原值</span></span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">salt</span> <span class="operator">=</span> ByteSource.Util.bytes(user + <span class="string">&quot;ABCDEFG&quot;</span>);<span class="comment">//以账号作为盐值+ABCDEFG</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">hashIterations</span> <span class="operator">=</span> <span class="number">1024</span>;<span class="comment">//加密1024次</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleHash</span>(hashAlgorithmName, crdentials, salt, hashIterations);</span><br><span class="line">        System.out.println(user + <span class="string">&quot;:&quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h1 id="编写自定义密码匹配类"><a href="#编写自定义密码匹配类" class="headerlink" title="编写自定义密码匹配类"></a>编写自定义密码匹配类</h1><p><strong>三种方式</strong></p><p>继承SimpleCredentialsMatcher 实现自定义加密</p><h2 id="自定义凭证匹配器-然后-直接对比密码是否跟库里相等"><a href="#自定义凭证匹配器-然后-直接对比密码是否跟库里相等" class="headerlink" title="自定义凭证匹配器 然后 直接对比密码是否跟库里相等"></a>自定义凭证匹配器 然后 直接对比密码是否跟库里相等</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjingc.demo.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.<span class="type">Slf4j</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.<span class="type">AuthenticationInfo</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.<span class="type">AuthenticationToken</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.<span class="type">UsernamePasswordToken</span>;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.<span class="type">SimpleCredentialsMatcher</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author cxc</span></span><br><span class="line"><span class="comment"> * 自定义密码校验器</span></span><br><span class="line"><span class="comment"> * 简单密码对比校验</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CredentialsMatcher</span> <span class="keyword">extends</span> <span class="title">SimpleCredentialsMatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义密码校验器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public boolean doCredentialsMatch(<span class="type">AuthenticationToken</span> token, <span class="type">AuthenticationInfo</span> info) &#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;进入自定义密码校验器&quot;</span>);</span><br><span class="line">        <span class="type">UsernamePasswordToken</span> utoken = (<span class="type">UsernamePasswordToken</span>) token;</span><br><span class="line">        <span class="comment">//获得用户输入的密码:(可以采用加盐(salt)的方式去检验)</span></span><br><span class="line">        <span class="type">String</span> inPassword = <span class="keyword">new</span> <span class="type">String</span>(utoken.getPassword());</span><br><span class="line">        <span class="comment">//获得数据库中的密码</span></span><br><span class="line">        <span class="type">String</span> dbPassword = (<span class="type">String</span>) info.getCredentials();</span><br><span class="line">        <span class="comment">//进行密码的比对</span></span><br><span class="line">        boolean flag = <span class="keyword">this</span>.equals(inPassword, dbPassword);</span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="自定义凭证匹配器-然后根据加盐来匹配"><a href="#自定义凭证匹配器-然后根据加盐来匹配" class="headerlink" title="自定义凭证匹配器 然后根据加盐来匹配"></a>自定义凭证匹配器 然后根据加盐来匹配</h2><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjingc.demo.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.<span class="keyword">extern</span>.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.SimpleCredentialsMatcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.hash.SimpleHash;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author cxc</span></span><br><span class="line"><span class="comment"> * 自定义密码校验器</span></span><br><span class="line"><span class="comment"> * 加盐校验</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">class</span> <span class="title">CredentialsSaltMatcher</span> <span class="keyword"><span class="keyword">extends</span> <span class="type">SimpleCredentialsMatcher</span></span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">&quot;$&#123;shiro.encrypt.type&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> encryptType;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">&quot;$&#123;shiro.HashIterations&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> int hashIterations;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">&quot;$&#123;shiro.salt&#125;&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> shiroSalt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义密码校验器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> boolean doCredentialsMatch(AuthenticationToken token, AuthenticationInfo info) &#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;进入自定义密码加盐校验器&quot;</span>);</span><br><span class="line">        UsernamePasswordToken utoken = (UsernamePasswordToken) token;</span><br><span class="line">        <span class="comment">//获得用户输入的密码:(可以采用加盐(salt)的方式去检验)</span></span><br><span class="line">        <span class="keyword">String</span> inPassword = <span class="keyword">new</span> <span class="type">SimpleHash</span>(encryptType, utoken.getPassword(), utoken.getUsername() + shiroSalt, hashIterations).toString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获得数据库中的密码</span></span><br><span class="line">        <span class="keyword">String</span> dbPassword = (<span class="keyword">String</span>) info.getCredentials();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//进行密码的比对</span></span><br><span class="line">        boolean flag = <span class="built_in">this</span>.equals(inPassword, dbPassword);</span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="直接写在ShiroConfig中-稍后创建"><a href="#直接写在ShiroConfig中-稍后创建" class="headerlink" title="直接写在ShiroConfig中  稍后创建"></a>直接写在ShiroConfig中 稍后创建</h2><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">HashedCredentialsMatcher</span> hashedCredentialsMatcher() &#123;</span><br><span class="line">        <span class="title class_">HashedCredentialsMatcher</span> hashedCredentialsMatcher = new <span class="title class_">HashedCredentialsMatcher</span>();</span><br><span class="line">        <span class="regexp">//stored</span>CredentialsHexEncoded默认是<span class="literal">true</span>，此时用的是密码加密用的是<span class="title class_">Hex</span>编码；<span class="literal">false</span>时用<span class="title class_">Base64</span>编码</span><br><span class="line">        hashedCredentialsMatcher.setStoredCredentialsHexEncoded(<span class="literal">true</span>);</span><br><span class="line">        <span class="regexp">//</span>散列算法<span class="symbol">:md5</span>,sha-<span class="number">1</span>,sha-<span class="number">256</span></span><br><span class="line">        hashedCredentialsMatcher.setHashAlgorithmName(encryptType);</span><br><span class="line">        <span class="regexp">//</span>散列次数</span><br><span class="line">        hashedCredentialsMatcher.setHashIterations(hashIterations);</span><br><span class="line">        <span class="keyword">return</span> hashedCredentialsMatcher;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><hr><h1 id="创建shiro生命周期配置类-单独"><a href="#创建shiro生命周期配置类-单独" class="headerlink" title="创建shiro生命周期配置类(单独)"></a>创建shiro生命周期配置类(单独)</h1><p><strong>如果不单独创建的话,放在shiro配置类中,可能会导致无注入value</strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjingc.demo.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.LifecycleBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> cxc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/10/12 15:52</span></span><br><span class="line"><span class="comment"> * shiro生命周期处理器(单独)</span></span><br><span class="line"><span class="comment"> * 如果放在shiroConfig中可能会导致<span class="doctag">@value</span>无法注入 所以单独放在一个配置类中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroInit</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Shiro生命周期处理器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LifecycleBeanPostProcessor lifecycleBeanPostProcessor() &#123;</span><br><span class="line">        <span class="keyword">return</span> new LifecycleBeanPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h1 id="创建shiro配置类-完整"><a href="#创建shiro配置类-完整" class="headerlink" title="创建shiro配置类(完整)"></a>创建shiro配置类(完整)</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjingc.demo.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> at.pollux.thymeleaf.shiro.dialect.ShiroDialect;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.HashedCredentialsMatcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.cache.ehcache.EhCacheManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.CookieRememberMeManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.SimpleCookie;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.DependsOn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> cxc</span></span><br><span class="line"><span class="comment"> * shiro配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;shiro.encrypt.type&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String encryptType;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;shiro.HashIterations&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> hashIterations;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;shiro.rememberMe.Max.time&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> rememberMeMaxTime;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ShiroFilterFactoryBean 处理拦截资源文件问题。</span></span><br><span class="line"><span class="comment">     * 注意：单独一个ShiroFilterFactoryBean配置是或报错的，以为在</span></span><br><span class="line"><span class="comment">     * 初始化ShiroFilterFactoryBean的时候需要注入：SecurityManager</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Filter Chain定义说明 1、一个URL可以配置多个Filter，使用逗号分隔 2、当设置多个过滤器时，全部验证通过，才视为通过</span></span><br><span class="line"><span class="comment">     * 3、部分过滤器可指定参数，如perms，roles</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">shirFilter</span><span class="params">(SecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilterFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">        <span class="comment">// 必须设置 SecurityManager 核心</span></span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果不设置默认会自动寻找Web工程根目录下的&quot;/login.jsp&quot;页面</span></span><br><span class="line">        <span class="comment">//打开页面跳转的地址</span></span><br><span class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        <span class="comment">// 登录成功后要跳转的链接</span></span><br><span class="line">        shiroFilterFactoryBean.setSuccessUrl(<span class="string">&quot;/index&quot;</span>);</span><br><span class="line">        <span class="comment">// 未授权界面;</span></span><br><span class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">&quot;/403&quot;</span>);</span><br><span class="line">        <span class="comment">// 拦截器.</span></span><br><span class="line">        Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, String&gt;();</span><br><span class="line">        <span class="comment">// 配置不会被拦截的链接 顺序判断</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/static/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/index&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/loginUser&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置退出过滤器,其中的具体的退出代码Shiro已经替我们实现了</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/logout&quot;</span>, <span class="string">&quot;logout&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置记住我的访问路径</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/success&quot;</span>, <span class="string">&quot;user&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置权限</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/lo1&quot;</span>, <span class="string">&quot;perms[add]&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/lo2&quot;</span>, <span class="string">&quot;perms[update]&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/lo3&quot;</span>, <span class="string">&quot;perms[delete]&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/lo4&quot;</span>, <span class="string">&quot;perms[User],perms[AAA]&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/lo5&quot;</span>, <span class="string">&quot;authc,roles[管理员],perms[AAA]&quot;</span>);</span><br><span class="line">        <span class="comment">// 这里为了测试，固定写死的值，也可以从数据库或其他配置中读取</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//需要通过认证</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/hello&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// &lt;!-- 过滤链定义，从上向下顺序执行，一般将 /**放在最为下边 --&gt;:这是一个坑呢，一不小心代码就不好使了;</span></span><br><span class="line">        <span class="comment">// &lt;!-- authc:所有url都必须认证通过才可以访问; anon:所有url都都可以匿名访问--&gt;</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加拦截器</span></span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line">        log.info(<span class="string">&quot;--------------------------Shiro拦截器工厂类注入成功------------------------------------&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用自定义方法</span></span><br><span class="line"><span class="comment">     * 安全管理器：securityManager 核心部分</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;securityManager&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> SecurityManager <span class="title function_">securityManager</span><span class="params">(<span class="meta">@Qualifier(&quot;authRealm&quot;)</span> AuthRealm authRealm)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;--------------------------shiro已经加载------------------------------------&quot;</span>);</span><br><span class="line">        <span class="type">DefaultWebSecurityManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">        <span class="comment">//设置realm</span></span><br><span class="line">        manager.setRealm(authRealm);</span><br><span class="line">        <span class="comment">//注入缓存管理器;</span></span><br><span class="line">        <span class="comment">//这个如果执行多次，也是同样的一个对象;</span></span><br><span class="line">        manager.setCacheManager(ehCacheManager());</span><br><span class="line">        <span class="comment">//注入记住我管理器</span></span><br><span class="line">        manager.setRememberMeManager(rememberMeManager());</span><br><span class="line">        <span class="keyword">return</span> manager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * shiro缓存管理器;</span></span><br><span class="line"><span class="comment">     * 需要注入对应的其它的实体类中：</span></span><br><span class="line"><span class="comment">     * EhCacheManager，缓存管理，用户登陆成功后，把用户信息和权限信息缓存起来，</span></span><br><span class="line"><span class="comment">     * 然后每次用户请求时，放入用户的session中，如果不设置这个bean，每个请求都会查询一次数据库。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;ehCacheManager&quot;)</span></span><br><span class="line">    <span class="comment">//控制bean加载顺序 表示被注解的bean在初始化时,指定的bean需要先完成初始化。</span></span><br><span class="line">    <span class="meta">@DependsOn(&quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> EhCacheManager <span class="title function_">ehCacheManager</span><span class="params">()</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;------------------shiro缓存注入成功-------------------------------&quot;</span>);</span><br><span class="line">        <span class="type">EhCacheManager</span> <span class="variable">cacheManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EhCacheManager</span>();</span><br><span class="line">        cacheManager.setCacheManagerConfigFile(<span class="string">&quot;classpath:config/ehcache-shiro.xml&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> cacheManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 身份认证realm; (这个需要自己写，账号密码校验；权限等)</span></span><br><span class="line"><span class="comment">     * 配置自定义的权限登录器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> matcher 参数是密码比较器,注入到authRealm中 以下自定义凭证匹配器三选一注入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;authRealm&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> AuthRealm <span class="title function_">authRealm</span><span class="params">(HashedCredentialsMatcher matcher)</span> &#123;</span><br><span class="line">        <span class="type">AuthRealm</span> <span class="variable">authRealm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthRealm</span>();</span><br><span class="line">        authRealm.setCredentialsMatcher(matcher);</span><br><span class="line">        <span class="keyword">return</span> authRealm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置自定义的凭证匹配器</span></span><br><span class="line">    <span class="comment">//方式一 加盐</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HashedCredentialsMatcher <span class="title function_">hashedCredentialsMatcher</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//自定义的凭证匹配器 可以用来记录密码错误次数</span></span><br><span class="line">        <span class="type">HashedCredentialsMatcher</span> <span class="variable">hashedCredentialsMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RetryLimitHashedCredentialsMatcher</span>(ehCacheManager());</span><br><span class="line">        <span class="comment">//原先的自定义凭证匹配器</span></span><br><span class="line">        <span class="comment">//HashedCredentialsMatcher hashedCredentialsMatcher = new HashedCredentialsMatcher();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//storedCredentialsHexEncoded默认是true，此时用的是密码加密用的是Hex编码；false时用Base64编码</span></span><br><span class="line">        hashedCredentialsMatcher.setStoredCredentialsHexEncoded(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//散列算法:md5,sha-1,sha-256</span></span><br><span class="line">        hashedCredentialsMatcher.setHashAlgorithmName(encryptType);</span><br><span class="line">        <span class="comment">//散列次数</span></span><br><span class="line">        hashedCredentialsMatcher.setHashIterations(hashIterations);</span><br><span class="line">        <span class="keyword">return</span> hashedCredentialsMatcher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//方式二 加密</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CredentialsSaltMatcher <span class="title function_">credentialsSaltMatcher</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CredentialsSaltMatcher</span> <span class="variable">credentialsSaltMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CredentialsSaltMatcher</span>();</span><br><span class="line">        <span class="keyword">return</span> credentialsSaltMatcher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//方式三 自定义加密</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CredentialsMatcher <span class="title function_">credentialsMatcher</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CredentialsMatcher</span> <span class="variable">credentialsMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CredentialsMatcher</span>();</span><br><span class="line">        <span class="keyword">return</span> credentialsMatcher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启Shiro的注解(如<span class="doctag">@RequiresRoles</span>,<span class="doctag">@RequiresPermissions</span>),需借助SpringAOP扫描使用Shiro注解的类,并在必要时进行安全逻辑验证</span></span><br><span class="line"><span class="comment">     * 配置以下两个bean(DefaultAdvisorAutoProxyCreator(可选)和AuthorizationAttributeSourceAdvisor)即可实现此功能</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启shiro aop注解支持.</span></span><br><span class="line"><span class="comment">     * 使用代理方式;所以需要开启代码支持;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> securityManager</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title function_">authorizationAttributeSourceAdvisor</span><span class="params">(SecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">AuthorizationAttributeSourceAdvisor</span> <span class="variable">authorizationAttributeSourceAdvisor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthorizationAttributeSourceAdvisor</span>();</span><br><span class="line">        authorizationAttributeSourceAdvisor.setSecurityManager(securityManager);</span><br><span class="line">        <span class="keyword">return</span> authorizationAttributeSourceAdvisor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@DependsOn(&#123;&quot;lifecycleBeanPostProcessor&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title function_">advisorAutoProxyCreator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultAdvisorAutoProxyCreator</span> <span class="variable">advisorAutoProxyCreator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAdvisorAutoProxyCreator</span>();</span><br><span class="line">        advisorAutoProxyCreator.setProxyTargetClass(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> advisorAutoProxyCreator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加ShiroDialect 为了在thymeleaf里使用shiro的标签的bean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;shiroDialect&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ShiroDialect <span class="title function_">shiroDialect</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ShiroDialect</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 记住我</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SimpleCookie <span class="title function_">rememberMeCookie</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;--------------------------shiro的记住我功能加载成功--------------------------&quot;</span>);</span><br><span class="line">        <span class="comment">//这个参数是cookie的名称，对应前端的checkbox的name = rememberMe</span></span><br><span class="line">        <span class="type">SimpleCookie</span> <span class="variable">simpleCookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleCookie</span>(<span class="string">&quot;rememberMe&quot;</span>);</span><br><span class="line">        <span class="comment">//&lt;!-- 记住我cookie生效时间30天 ,单位秒;--&gt;</span></span><br><span class="line">        simpleCookie.setMaxAge(rememberMeMaxTime);</span><br><span class="line">        <span class="keyword">return</span> simpleCookie;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cookie管理对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CookieRememberMeManager <span class="title function_">rememberMeManager</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;--------------------------shiroCookie管理对象加载成功--------------------------&quot;</span>);</span><br><span class="line">        <span class="type">CookieRememberMeManager</span> <span class="variable">cookieRememberMeManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CookieRememberMeManager</span>();</span><br><span class="line">        cookieRememberMeManager.setCookie(rememberMeCookie());</span><br><span class="line">        <span class="keyword">return</span> cookieRememberMeManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h1 id="shiro配置类中加入-thymeleaf-在页面使用shiro的标签的bean"><a href="#shiro配置类中加入-thymeleaf-在页面使用shiro的标签的bean" class="headerlink" title="shiro配置类中加入 thymeleaf 在页面使用shiro的标签的bean"></a>shiro配置类中加入 thymeleaf 在页面使用shiro的标签的bean</h1><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加ShiroDialect 为了在thymeleaf里使用shiro的标签的bean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Bean(name = <span class="string">&quot;shiroDialect&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ShiroDialect <span class="title">shiroDialect</span>()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ShiroDialect();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>页面:<br><code>&lt;html xmlns:shiro=&quot;http://www.pollix.at/thymeleaf/shiro&quot;&gt;</code></p><p>使用:</p><blockquote><p>可以参考 <a target="_blank" rel="noopener" href="https://github.com/theborakompanioni/thymeleaf-extras-shiro">thymeleaf-extras-shiro 看标签使用</a></p></blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">基本语法:</span><br><span class="line"></span><br><span class="line">&lt;shiro:principal/&gt;        表示获取这个用户的对象</span><br><span class="line"></span><br><span class="line">&lt;shiro:principal <span class="attribute">property</span>=<span class="string">&quot;username&quot;</span> /&gt;        表示获取这用户的属性</span><br><span class="line"></span><br><span class="line">&lt;shiro:<span class="attribute">guest</span>=<span class="string">&quot;&gt;       验证当前用户是否为“访客” 未登录。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;shiro:user=&quot;</span><span class="string">&quot;&gt;        认证通过或已记住的用户</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;shiro:authenticated=&quot;</span><span class="string">&quot;&gt;      当前用户认证通过 和 未记住用户 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;shiro:notAuthenticated=&quot;</span><span class="string">&quot;&gt;   当前用户认证通过   和 已记住用户  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;shiro:hasRole=&quot;</span>admin&quot; &gt;      判断当前用户拥有这个角色</span><br><span class="line"></span><br><span class="line">&lt;p shiro:<span class="attribute">lacksRole</span>=<span class="string">&quot;developer&quot;</span>&gt;     判断当前用户没有这个角色</span><br><span class="line"></span><br><span class="line">&lt;p shiro:<span class="attribute">hasAllRoles</span>=<span class="string">&quot;developer, admin&quot;</span>&gt;     判断当前用户是否拥有这些角色所有</span><br><span class="line"></span><br><span class="line">&lt;p shiro:<span class="attribute">hasAnyRoles</span>=<span class="string">&quot;foo, bar&quot;</span>&gt;      判断当前用户是否拥有这些角色之一</span><br><span class="line"></span><br><span class="line">&lt;p shiro:<span class="attribute">hasPermission</span>=<span class="string">&quot;userInfo:add&quot;</span>&gt;     判断用户是否拥有当前指定权限</span><br><span class="line"></span><br><span class="line">&lt;p shiro: lacksPermission =<span class="string">&quot;userInfo:add&quot;</span>&gt;    判断用户是否不拥有当前指定权限</span><br><span class="line"></span><br><span class="line">&lt;p shiro: hasAllPermissions =<span class="string">&quot;userInfo:add&quot;</span>&gt;    判断用户是否拥有当前所有权限</span><br><span class="line"></span><br><span class="line">&lt;p shiro: hasAnyPermissions =<span class="string">&quot;userInfo:add&quot;</span>&gt;    判断用户是否拥有当前权限之一</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>案例:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/1999/xhtml&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:shiro</span>=<span class="string">&quot;http://www.pollix.at/thymeleaf/shiro&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Insert title here<span class="tag">&lt;/<span class="name">title</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>index<span class="tag">&lt;/<span class="name">h3</span>&gt;</span> </span><br><span class="line">    <span class="comment">&lt;!-- 验证当前用户是否为“访客”，即未认证（包含未记住）的用户。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">shiro:guest</span>=<span class="string">&quot;&quot;</span>&gt;</span>Please <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;login.html&quot;</span>&gt;</span>login<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 认证通过或已记住的用户。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">shiro:user</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">       Welcome back John! Not John? Click <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;login.html&quot;</span>&gt;</span>here<span class="tag">&lt;/<span class="name">a</span>&gt;</span> to login.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 已认证通过的用户。不包含已记住的用户，这是与user标签的区别所在。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">shiro:authenticated</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">      Hello, <span class="tag">&lt;<span class="name">span</span> <span class="attr">shiro:principal</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span>, how are you today?</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">shiro:authenticated</span>=<span class="string">&quot;&quot;</span> <span class="attr">href</span>=<span class="string">&quot;updateAccount.html&quot;</span>&gt;</span>Update your contact information<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 输出当前用户信息，通常为登录帐号信息。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello, <span class="tag">&lt;<span class="name">shiro:principal</span>/&gt;</span>, how are you today?<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 未认证通过用户，与authenticated标签相对应。与guest标签的区别是，该标签包含已记住用户。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">shiro:notAuthenticated</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">       Please <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;login.html&quot;</span>&gt;</span>login<span class="tag">&lt;/<span class="name">a</span>&gt;</span> in order to update your credit card information.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">     </span><br><span class="line">    <span class="comment">&lt;!-- 验证当前用户是否属于该角色。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">shiro:hasRole</span>=<span class="string">&quot;admin&quot;</span> <span class="attr">href</span>=<span class="string">&quot;admin.html&quot;</span>&gt;</span>Administer the system<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="comment">&lt;!-- 拥有该角色 --&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 与hasRole标签逻辑相反，当用户不属于该角色时验证通过。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">shiro:lacksRole</span>=<span class="string">&quot;developer&quot;</span>&gt;</span><span class="comment">&lt;!-- 没有该角色 --&gt;</span></span><br><span class="line">      Sorry, you are not allowed to developer the system.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 验证当前用户是否属于以下所有角色。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">shiro:hasAllRoles</span>=<span class="string">&quot;developer, admin&quot;</span>&gt;</span><span class="comment">&lt;!-- 角色与判断 --&gt;</span></span><br><span class="line">       You are a developer and a admin.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 验证当前用户是否属于以下任意一个角色。  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">shiro:hasAnyRoles</span>=<span class="string">&quot;admin, vip, developer&quot;</span>&gt;</span><span class="comment">&lt;!-- 角色或判断 --&gt;</span></span><br><span class="line">         You are a admin, vip, or developer.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--验证当前用户是否拥有指定权限。  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">shiro:hasPermission</span>=<span class="string">&quot;userInfo:add&quot;</span> <span class="attr">href</span>=<span class="string">&quot;createUser.html&quot;</span>&gt;</span>添加用户<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="comment">&lt;!-- 拥有权限 --&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 与hasPermission标签逻辑相反，当前用户没有制定权限时，验证通过。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">shiro:lacksPermission</span>=<span class="string">&quot;userInfo:del&quot;</span>&gt;</span><span class="comment">&lt;!-- 没有权限 --&gt;</span></span><br><span class="line">         Sorry, you are not allowed to delete user accounts.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 验证当前用户是否拥有以下所有权限。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">shiro:hasAllPermissions</span>=<span class="string">&quot;userInfo:view, userInfo:add&quot;</span>&gt;</span><span class="comment">&lt;!-- 权限与判断 --&gt;</span></span><br><span class="line">           You can see or add users.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 验证当前用户是否拥有以下任意一个权限。  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">shiro:hasAnyPermissions</span>=<span class="string">&quot;userInfo:view, userInfo:del&quot;</span>&gt;</span><span class="comment">&lt;!-- 权限或判断 --&gt;</span></span><br><span class="line">               You can see or delete users.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h1 id="shiro配置类中加入-实现-代码中使用注解"><a href="#shiro配置类中加入-实现-代码中使用注解" class="headerlink" title="shiro配置类中加入 实现 代码中使用注解"></a>shiro配置类中加入 实现 代码中使用注解</h1><p>开启Shiro的注解(如@RequiresRoles,@RequiresPermissions)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 开启Shiro的注解(如<span class="doctag">@RequiresRoles</span>,<span class="doctag">@RequiresPermissions</span>),需借助SpringAOP扫描使用Shiro注解的类,并在必要时进行安全逻辑验证</span></span><br><span class="line"><span class="comment">    * 配置以下两个bean(DefaultAdvisorAutoProxyCreator(可选)和AuthorizationAttributeSourceAdvisor)即可实现此功能</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *  开启shiro aop注解支持.</span></span><br><span class="line"><span class="comment">    *  使用代理方式;所以需要开启代码支持;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> securityManager</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title function_">authorizationAttributeSourceAdvisor</span><span class="params">(SecurityManager securityManager)</span> &#123;</span><br><span class="line">       <span class="type">AuthorizationAttributeSourceAdvisor</span> <span class="variable">authorizationAttributeSourceAdvisor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthorizationAttributeSourceAdvisor</span>();</span><br><span class="line">       authorizationAttributeSourceAdvisor.setSecurityManager(securityManager);</span><br><span class="line">       <span class="keyword">return</span> authorizationAttributeSourceAdvisor;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@DependsOn(&#123;&quot;lifecycleBeanPostProcessor&quot;&#125;)</span></span><br><span class="line">   <span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title function_">advisorAutoProxyCreator</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">DefaultAdvisorAutoProxyCreator</span> <span class="variable">advisorAutoProxyCreator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAdvisorAutoProxyCreator</span>();</span><br><span class="line">       advisorAutoProxyCreator.setProxyTargetClass(<span class="literal">true</span>);</span><br><span class="line">       <span class="keyword">return</span> advisorAutoProxyCreator;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>使用:</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@RequiresAuthentication</span>   表示当前Subject已经通过login 进行了身份验证；即Subject. <span class="built_in">isAuthenticated</span>()返回true。  </span><br><span class="line"></span><br><span class="line"><span class="variable">@RequiresUser</span>   表示当前Subject已经身份验证或者通过记住我登录的。</span><br><span class="line"></span><br><span class="line"><span class="variable">@RequiresGuest</span>   　　表示当前Subject没有身份验证或通过记住我登录过，即是游客身份。</span><br><span class="line"></span><br><span class="line"><span class="variable">@RequiresRoles</span>(value=&#123;“admin”, “user”&#125;, logical= Logical.<span class="keyword">AND</span>)</span><br><span class="line"><span class="variable">@RequiresRoles</span>(value=&#123;“admin”&#125;)</span><br><span class="line"><span class="variable">@RequiresRoles</span>(&#123;“admin“&#125;)</span><br><span class="line">表示当前Subject需要角色admin 和user。</span><br><span class="line"> </span><br><span class="line"><span class="variable">@RequiresPermissions</span> (value=&#123;“<span class="attribute">user</span>:a”, “<span class="attribute">user</span>:b”&#125;, logical= Logical.<span class="keyword">OR</span>)</span><br><span class="line">表示当前Subject需要权限<span class="attribute">user</span>:a或<span class="attribute">user</span>:b。</span><br><span class="line"></span><br><span class="line">既可以用在controller中，也可以用在service中</span><br><span class="line">建议将shiro注解放入controller，因为如果service层使用了spring的事物注解，那么shiro注解将无效</span><br></pre></td></tr></table></figure><hr><h1 id="在shiro中加入EhCache缓存-缓存用户权限信息"><a href="#在shiro中加入EhCache缓存-缓存用户权限信息" class="headerlink" title="在shiro中加入EhCache缓存 缓存用户权限信息"></a>在shiro中加入EhCache缓存 缓存用户权限信息</h1><blockquote><p>作用:<br>实际中我们的权限信息是不怎么会改变的，所以我们希望是第一次访问，然后进行缓存处理，那么Shiro是否支持呢，答案是肯定的，Shiro中加入缓存机制。</p></blockquote><blockquote><p>简单来说 就是每次需要验证权限信息的时候都要查询一次 现在就直接丢进缓存中去</p></blockquote><h2 id="导入pom-xml-看顶部标题-导入pom的那部分"><a href="#导入pom-xml-看顶部标题-导入pom的那部分" class="headerlink" title="导入pom.xml  看顶部标题 导入pom的那部分"></a>导入pom.xml 看顶部标题 导入pom的那部分</h2><h2 id="在shiro配置类中加入EhCache缓存器"><a href="#在shiro配置类中加入EhCache缓存器" class="headerlink" title="在shiro配置类中加入EhCache缓存器"></a>在shiro配置类中加入EhCache缓存器</h2><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * shiro缓存管理器;</span></span><br><span class="line"><span class="comment">     * 需要注入对应的其它的实体类中：</span></span><br><span class="line"><span class="comment">     * EhCacheManager，缓存管理，用户登陆成功后，把用户信息和权限信息缓存起来，</span></span><br><span class="line"><span class="comment">     * 然后每次用户请求时，放入用户的session中，如果不设置这个bean，每个请求都会查询一次数据库。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">&quot;ehCacheManager&quot;</span>)</span><br><span class="line">    <span class="comment">//控制bean加载顺序 表示被注解的bean在初始化时,指定的bean需要先完成初始化。</span></span><br><span class="line">    <span class="meta">@DependsOn</span>(<span class="string">&quot;lifecycleBeanPostProcessor&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> EhCacheManager ehCacheManager() &#123;</span><br><span class="line">        log.info(<span class="string">&quot;------------------shiro缓存注入成功-------------------------------&quot;</span>);</span><br><span class="line">        EhCacheManager cacheManager = <span class="keyword">new</span> <span class="type">EhCacheManager</span>();</span><br><span class="line">        cacheManager.setCacheManagerConfigFile(<span class="string">&quot;classpath:config/ehcache-shiro.xml&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> cacheManager;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="在resources中添加关于EhCache的配置文件"><a href="#在resources中添加关于EhCache的配置文件" class="headerlink" title="在resources中添加关于EhCache的配置文件"></a>在resources中添加关于EhCache的配置文件</h2><p>路径: <code>config/ehcache-shiro.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ehcache</span> <span class="attr">name</span>=<span class="string">&quot;es&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">diskStore</span> <span class="attr">path</span>=<span class="string">&quot;java.io.tmpdir&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  name:缓存名称。</span></span><br><span class="line"><span class="comment">  maxElementsInMemory:缓存最大数目</span></span><br><span class="line"><span class="comment">  maxElementsOnDisk：硬盘最大缓存个数。</span></span><br><span class="line"><span class="comment">  eternal:对象是否永久有效，一但设置了，timeout将不起作用。</span></span><br><span class="line"><span class="comment">  overflowToDisk:是否保存到磁盘，当系统当机时</span></span><br><span class="line"><span class="comment">  timeToIdleSeconds:设置对象在失效前的允许闲置时间（单位：秒）。仅当eternal=false对象不是永久有效时使用，可选属性，默认值是0，也就是可闲置时间无穷大。</span></span><br><span class="line"><span class="comment">  timeToLiveSeconds:设置对象在失效前允许存活时间（单位：秒）。最大时间介于创建时间和失效时间之间。仅当eternal=false对象不是永久有效时使用，默认是0.，也就是对象存活时间无穷大。</span></span><br><span class="line"><span class="comment">  diskPersistent：是否缓存虚拟机重启期数据 Whether the disk store persists between restarts of the Virtual Machine. The default value is false.</span></span><br><span class="line"><span class="comment">  diskSpoolBufferSizeMB：这个参数设置DiskStore（磁盘缓存）的缓存区大小。默认是30MB。每个Cache都应该有自己的一个缓冲区。</span></span><br><span class="line"><span class="comment">  diskExpiryThreadIntervalSeconds：磁盘失效线程运行时间间隔，默认是120秒。</span></span><br><span class="line"><span class="comment">  memoryStoreEvictionPolicy：当达到maxElementsInMemory限制时，Ehcache将会根据指定的策略去清理内存。默认策略是LRU（最近最少使用）。你可以设置为FIFO（先进先出）或是LFU（较少使用）。</span></span><br><span class="line"><span class="comment">  clearOnFlush：内存数量最大时是否清除。</span></span><br><span class="line"><span class="comment">  memoryStoreEvictionPolicy:</span></span><br><span class="line"><span class="comment">       Ehcache的三种清空策略;</span></span><br><span class="line"><span class="comment">       FIFO，first in first out，这个是大家最熟的，先进先出。</span></span><br><span class="line"><span class="comment">       LFU， Less Frequently Used，就是上面例子中使用的策略，直白一点就是讲一直以来最少被使用的。如上面所讲，缓存的元素有一个hit属性，hit值最小的将会被清出缓存。</span></span><br><span class="line"><span class="comment">       LRU，Least Recently Used，最近最少使用的，缓存的元素有一个时间戳，当缓存容量满了，而又需要腾出地方来缓存新的元素的时候，那么现有缓存元素中时间戳离当前时间最远的元素将被清出缓存。</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">defaultCache</span></span></span><br><span class="line"><span class="tag">            <span class="attr">maxElementsInMemory</span>=<span class="string">&quot;10000&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">eternal</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">timeToIdleSeconds</span>=<span class="string">&quot;120&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">timeToLiveSeconds</span>=<span class="string">&quot;120&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">overflowToDisk</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">diskPersistent</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">diskExpiryThreadIntervalSeconds</span>=<span class="string">&quot;120&quot;</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 登录记录缓存锁定10分钟 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">&quot;passwordRetryCache&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">maxEntriesLocalHeap</span>=<span class="string">&quot;2000&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">eternal</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">timeToIdleSeconds</span>=<span class="string">&quot;3600&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">timeToLiveSeconds</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">overflowToDisk</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">statistics</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">cache</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="开启的Ehcache加入到shiro的安全管理器中"><a href="#开启的Ehcache加入到shiro的安全管理器中" class="headerlink" title="开启的Ehcache加入到shiro的安全管理器中"></a>开启的Ehcache加入到shiro的安全管理器中</h2><p><code>就是那个我们自定义的securityManager</code></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//注入缓存管理器<span class="comment">;</span></span><br><span class="line">//这个如果执行多次，也是同样的一个对象<span class="comment">;</span></span><br><span class="line">manager.setCacheManager(ehCacheManager())<span class="comment">;</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure><p>这样就开启了缓存</p><hr><h1 id="shiro使用缓存来存储用户验证时密码多次输入错误"><a href="#shiro使用缓存来存储用户验证时密码多次输入错误" class="headerlink" title="shiro使用缓存来存储用户验证时密码多次输入错误"></a>shiro使用缓存来存储用户验证时密码多次输入错误</h1><blockquote><p>CredentialsMatcher是shiro提供的用于加密密码和验证密码服务的接口，而HashedCredentialsMatcher正是CredentialsMatcher的一个实现类</p></blockquote><p>所以我们需要修改 原先的自定义自定义凭证匹配器 在里面加入关于用户验证密码</p><h2 id="创建一个自定义的类-继承-HashedCredentialsMatcher"><a href="#创建一个自定义的类-继承-HashedCredentialsMatcher" class="headerlink" title="创建一个自定义的类 继承 HashedCredentialsMatcher"></a>创建一个自定义的类 继承 <code>HashedCredentialsMatcher</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.linjingc.demo.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.ExcessiveAttemptsException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.HashedCredentialsMatcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.cache.Cache;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.cache.CacheManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> cxc</span></span><br><span class="line"><span class="comment"> * 自定义密码校验器误次数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RetryLimitHashedCredentialsMatcher</span> <span class="keyword">extends</span> <span class="title class_">HashedCredentialsMatcher</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Cache&lt;String, AtomicInteger&gt; passwordRetryCache;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;shiro.password.error.size&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> passwordErrorSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RetryLimitHashedCredentialsMatcher</span><span class="params">(CacheManager cacheManager)</span> &#123;</span><br><span class="line">        <span class="comment">//用于记录缓存的名称 passwordRetryCache</span></span><br><span class="line">        passwordRetryCache = cacheManager.getCache(<span class="string">&quot;passwordRetryCache&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">doCredentialsMatch</span><span class="params">(AuthenticationToken token,</span></span><br><span class="line"><span class="params">                                      AuthenticationInfo info)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> (String) token.getPrincipal();</span><br><span class="line">        <span class="comment">// retry count + 1  </span></span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">retryCount</span> <span class="operator">=</span> passwordRetryCache.get(username);</span><br><span class="line">        <span class="keyword">if</span> (retryCount == <span class="literal">null</span>) &#123;</span><br><span class="line">            retryCount = <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">            passwordRetryCache.put(username, retryCount);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (retryCount.incrementAndGet() &gt; passwordErrorSize) &#123;</span><br><span class="line">            <span class="comment">// if retry count &gt; 5 throw</span></span><br><span class="line">            <span class="comment">//超出定义的错误次数后 抛出一个异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExcessiveAttemptsException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">matches</span> <span class="operator">=</span> <span class="built_in">super</span>.doCredentialsMatch(token, info);</span><br><span class="line">        <span class="keyword">if</span> (matches) &#123;</span><br><span class="line">            <span class="comment">// clear retry count  </span></span><br><span class="line">            passwordRetryCache.remove(username);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> matches;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在回调方法<code>doCredentialsMatch(AuthenticationToken token,AuthenticationInfo info)</code>中进行身份认证的密码匹配，这里我们引入了<code>Ehcahe</code>用于保存用户登录次数，如果登录失败<code>retryCount</code>变量则会一直累加，如果登录成功，那么这个<code>count</code>就会从缓存中移除，从而实现了如果登录次数超出指定的值就锁定。</p><p><strong>这样到达上限后 会抛出<code>throw ExcessiveAttemptsException()</code> 这样我们可以在登录的方法中捕获抛出自定义提示</strong></p><h2 id="修改shiroConfig中的自定义密码校验器"><a href="#修改shiroConfig中的自定义密码校验器" class="headerlink" title="修改shiroConfig中的自定义密码校验器"></a>修改shiroConfig中的自定义密码校验器</h2><p>将原先的直接new的 <code>HashedCredentialsMatcher</code> 改成我们自定义的<code>RetryLimitHashedCredentialsMatcher</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置自定义的凭证匹配器</span></span><br><span class="line">   <span class="comment">//方式一 加盐</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> HashedCredentialsMatcher <span class="title function_">hashedCredentialsMatcher</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">//自定义的凭证匹配器 可以用来记录密码错误次数</span></span><br><span class="line">       <span class="type">HashedCredentialsMatcher</span> <span class="variable">hashedCredentialsMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RetryLimitHashedCredentialsMatcher</span>(ehCacheManager());</span><br><span class="line">       <span class="comment">//原先的自定义凭证匹配器</span></span><br><span class="line">       <span class="comment">//HashedCredentialsMatcher hashedCredentialsMatcher = new HashedCredentialsMatcher();</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">//storedCredentialsHexEncoded默认是true，此时用的是密码加密用的是Hex编码；false时用Base64编码</span></span><br><span class="line">       hashedCredentialsMatcher.setStoredCredentialsHexEncoded(<span class="literal">true</span>);</span><br><span class="line">       <span class="comment">//散列算法:md5,sha-1,sha-256</span></span><br><span class="line">       hashedCredentialsMatcher.setHashAlgorithmName(encryptType);</span><br><span class="line">       <span class="comment">//散列次数</span></span><br><span class="line">       hashedCredentialsMatcher.setHashIterations(hashIterations);</span><br><span class="line">       <span class="keyword">return</span> hashedCredentialsMatcher;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="在Ehcache-xml中添加关于密码错误次数的缓存"><a href="#在Ehcache-xml中添加关于密码错误次数的缓存" class="headerlink" title="在Ehcache.xml中添加关于密码错误次数的缓存"></a>在Ehcache.xml中添加关于密码错误次数的缓存</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 登录记录缓存锁定10分钟 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">&quot;passwordRetryCache&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">maxEntriesLocalHeap</span>=<span class="string">&quot;2000&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">eternal</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">timeToIdleSeconds</span>=<span class="string">&quot;3600&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">timeToLiveSeconds</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">overflowToDisk</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">           <span class="attr">statistics</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">cache</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="在application-properties中添加"><a href="#在application-properties中添加" class="headerlink" title="在application.properties中添加"></a>在application.properties中添加</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#自定义密码错误上限</span></span><br><span class="line"><span class="attr">shiro.password.error.size</span>=<span class="number">5</span></span><br></pre></td></tr></table></figure><hr><h1 id="记住密码"><a href="#记住密码" class="headerlink" title="记住密码"></a>记住密码</h1><h2 id="加入两个方法"><a href="#加入两个方法" class="headerlink" title="加入两个方法"></a>加入两个方法</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 记住我</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   @Bean</span><br><span class="line">   <span class="function"><span class="keyword">public</span> SimpleCookie <span class="title">rememberMeCookie</span>()</span> &#123;</span><br><span class="line"></span><br><span class="line">       log.info(<span class="string">&quot;--------------------------shiro的记住我功能加载成功--------------------------&quot;</span>);</span><br><span class="line">       <span class="comment">//这个参数是cookie的名称，对应前端的checkbox的name = rememberMe</span></span><br><span class="line">       SimpleCookie simpleCookie = <span class="keyword">new</span> SimpleCookie(<span class="string">&quot;rememberMe&quot;</span>);</span><br><span class="line">       <span class="comment">//&lt;!-- 记住我cookie生效时间30天 ,单位秒;--&gt;</span></span><br><span class="line">       simpleCookie.setMaxAge(rememberMeMaxTime);</span><br><span class="line">       <span class="keyword">return</span> simpleCookie;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Cookie管理对象</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   @Bean</span><br><span class="line">   <span class="function"><span class="keyword">public</span> CookieRememberMeManager <span class="title">rememberMeManager</span>()</span> &#123;</span><br><span class="line"></span><br><span class="line">       log.info(<span class="string">&quot;--------------------------shiroCookie管理对象加载成功--------------------------&quot;</span>);</span><br><span class="line">       CookieRememberMeManager cookieRememberMeManager = <span class="keyword">new</span> CookieRememberMeManager();</span><br><span class="line">       cookieRememberMeManager.setCookie(rememberMeCookie());</span><br><span class="line">       <span class="keyword">return</span> cookieRememberMeManager;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="加入到安全管理器中"><a href="#加入到安全管理器中" class="headerlink" title="加入到安全管理器中"></a>加入到安全管理器中</h2><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  <span class="string">//</span>注入记住我管理器</span><br><span class="line">manager.<span class="keyword">set</span>RememberMeManager<span class="params">(rememberMeManager()</span>);</span><br></pre></td></tr></table></figure><h2 id="然后再Shirofiter过滤器中添加-记住我的路径"><a href="#然后再Shirofiter过滤器中添加-记住我的路径" class="headerlink" title="然后再Shirofiter过滤器中添加 记住我的路径"></a>然后再Shirofiter过滤器中添加 记住我的路径</h2><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置记住我的访问路径</span></span><br><span class="line">       filterChainDefinitionMap.<span class="keyword">put</span>(<span class="string">&quot;/success&quot;</span>, <span class="string">&quot;user&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="登录界面加入rememberMe复选框"><a href="#登录界面加入rememberMe复选框" class="headerlink" title="登录界面加入rememberMe复选框"></a>登录界面加入rememberMe复选框</h2><p><code>&lt;div&gt;&lt;label&gt; 记住我 : &lt;input type=&quot;checkbox&quot; name=&quot;rememberMe&quot;/&gt; &lt;/label&gt;&lt;/div&gt;</code></p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>这样关闭浏览器还是可以访问的</p><p>这时候运行程序，登录之后跳转到&#x2F;index页面，然后我们关闭浏览器，然后直接访问&#x2F;index还是可以访问的，说明我们写的记住密码已经生效了，但是只能访问 过滤器中user类型的路径 其他还是需要登陆的</p><hr><h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><h1 id="启动时报错-【Springboot-Themeleaf模板-Shiro标签】找不到类AbstractProcessorDialect解决"><a href="#启动时报错-【Springboot-Themeleaf模板-Shiro标签】找不到类AbstractProcessorDialect解决" class="headerlink" title="启动时报错 【Springboot+Themeleaf模板+Shiro标签】找不到类AbstractProcessorDialect解决"></a>启动时报错 【Springboot+Themeleaf模板+Shiro标签】找不到类AbstractProcessorDialect解决</h1><blockquote><p>使用的SpringBoot1.5.2.RELEASE版本集成Thymeleaf时，它使用的版本是2.1.5.RELEASE，而在这个版本中没有<code>AbstractProcessorDialect</code>类。</p></blockquote><p>解决方法一：可以把Thymeleaf版本更改为3.0.7.RELEASE<br><code>&lt;thymeleaf.version&gt;3.0.7.RELEASE&lt;/thymeleaf.version&gt;</code><br>再加上<br><code>&lt;thymeleaf-layout-dialect.version&gt;2.2.2&lt;/thymeleaf-layout-dialect.version&gt;</code></p><p>解决方法二：还可以把thymeleaf-extras-shiro的版本改为1.2.1</p><hr><h1 id="遇到-value-无法注入到配置类的情况"><a href="#遇到-value-无法注入到配置类的情况" class="headerlink" title="遇到@value() 无法注入到配置类的情况"></a>遇到@value() 无法注入到配置类的情况</h1><blockquote><p>参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_37962779/article/details/78605478">BeanPostProcessor加载次序及其对Bean造成的影响分析</a></p></blockquote><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">解决方案:</span><br><span class="line"></span><br><span class="line">将 LifecycleBeanPostProcessor 单独抽出到一个<span class="symbol">@Configuration</span></span><br></pre></td></tr></table></figure><h1 id="如果权限验证类中-的认证出错的话"><a href="#如果权限验证类中-的认证出错的话" class="headerlink" title="如果权限验证类中 的认证出错的话"></a>如果权限验证类中 的认证出错的话</h1><p>页面的shiro: XXX 标签是无法使用的</p><h1 id="登录登出的时候org-apache-shiro-crypto-CryptoException-Unable-to-execute-‘doFinal’-with-cipher-instance"><a href="#登录登出的时候org-apache-shiro-crypto-CryptoException-Unable-to-execute-‘doFinal’-with-cipher-instance" class="headerlink" title="登录登出的时候org.apache.shiro.crypto.CryptoException: Unable to execute ‘doFinal’ with cipher instance"></a>登录登出的时候org.apache.shiro.crypto.CryptoException: Unable to execute ‘doFinal’ with cipher instance</h1><p>参考: <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_21727627/article/details/72850391">看这里</a></p><hr></div><footer class="post-footer"><div class="post-tags"><a href="/tags/SpringBoot/" rel="tag"># SpringBoot</a> <a href="/tags/shiro/" rel="tag"># shiro</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2018/10/11/SpringBoot%E6%95%B4%E5%90%88shiro(%E6%97%A7)/" rel="prev" title="SpringBoot整合shiro(旧)"><i class="fa fa-angle-left"></i> SpringBoot整合shiro(旧)</a></div><div class="post-nav-item"><a href="/2018/10/15/easyui%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0%E7%A9%BA%E9%97%B4%E6%97%A0%E6%B3%95%E6%B8%B2%E6%9F%93-parser-parse%E6%97%A0%E6%95%88/" rel="next" title="easyui动态添加空间无法渲染$.parser.parse无效">easyui动态添加空间无法渲染$.parser.parse无效 <i class="fa fa-angle-right"></i></a></div></div></footer></article></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">一只写Bug的猫</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>站点总字数：</span> <span title="站点总字数">2.7m</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">40:35</span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div></div></footer><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a href="https://github.com/AsummerCat/AsmmerCatHexo" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script><script>var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();</script></body></html>